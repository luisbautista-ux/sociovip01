rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if the user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to get user profile from Firestore
    function getUserProfile(userId) {
      return get(/databases/$(database)/documents/platformUsers/$(userId)).data;
    }
    
    // Helper function to check if the user is an admin or staff for a specific business
    function isBusinessAdminOrStaff(businessId) {
      let userProfile = getUserProfile(request.auth.uid);
      return isSignedIn() && 
             (userProfile.businessId == businessId) && 
             ('business_admin' in userProfile.roles || 'staff' in userProfile.roles);
    }
    
    // Regla para la carpeta de negocios
    // businesses/{businessId}/{logo o cover}/{fileName}
    match /businesses/{businessId}/{imageType}/{fileName} {
      // Cualquiera puede leer las imágenes (para las páginas públicas)
      allow read: if true;
      
      // Solo el admin o staff de ese negocio específico puede escribir (crear, actualizar, eliminar)
      // El businessId en la ruta del archivo debe coincidir con el businessId en el perfil del usuario.
      allow write: if isSignedIn() && isBusinessAdminOrStaff(businessId);
    }

    // Otras reglas para otras carpetas pueden ir aquí.
    // Por defecto, se deniega el acceso a cualquier otra ruta.
  }
}
