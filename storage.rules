rules_version = '2';

// Reglas de seguridad para Cloud Storage
service firebase.storage {
  match /b/{bucket}/o {

    // Regla para la carpeta de imágenes de negocios
    // businesses/{businessId}/{logo o cover}
    match /businesses/{businessId}/{allPaths=**} {
      
      // PERMITIR LECTURA PÚBLICA:
      // Cualquiera puede ver las imágenes (logos, portadas) de los negocios.
      // Esto es necesario para que las páginas públicas puedan mostrarlas.
      allow read: if true;

      // PERMITIR ESCRITURA (subir, actualizar, eliminar) SOLO A USUARIOS AUTORIZADOS:
      // Para escribir, el usuario debe:
      // 1. Estar autenticado (request.auth != null).
      // 2. Tener un perfil en Firestore en /platformUsers/{request.auth.uid}.
      // 3. Su perfil debe tener el 'businessId' que coincide con el de la carpeta.
      // 4. Su rol debe ser 'business_admin' o 'staff'.
      allow write: if request.auth != null && 
                      exists(/databases/(default)/documents/platformUsers/$(request.auth.uid)) &&
                      get(/databases/(default)/documents/platformUsers/$(request.auth.uid)).data.businessId == businessId &&
                      ('business_admin' in get(/databases/(default)/documents/platformUsers/$(request.auth.uid)).data.roles || 
                       'staff' in get(/databases/(default)/documents/platformUsers/$(request.auth.uid)).data.roles);
    }

    // Puedes añadir más reglas para otras carpetas aquí si es necesario
    // Por ejemplo, para imágenes de perfil de usuario:
    // match /userProfiles/{userId}/{allPaths=**} {
    //   allow read;
    //   allow write: if request.auth != null && request.auth.uid == userId;
    // }
  }
}
