rules_version = '2';

// Documentación de las Reglas de Storage: https://firebase.google.com/docs/storage/security
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if the user is an admin of the business
    function isBusinessAdminOrStaff(businessId) {
      // Allow access if the user's profile in Firestore for this businessId
      // has the role 'business_admin' or 'staff'.
      let userProfile = get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data;
      return request.auth != null &&
             userProfile.businessId == businessId &&
             (userProfile.roles.hasAny(['business_admin', 'staff']));
    }
    
    // Reglas para los archivos de los negocios (logos, portadas, etc.)
    // La ruta es: businesses/{businessId}/{allPaths=**}
    match /businesses/{businessId}/{allPaths=**} {

      // Lectura: cualquiera puede leer las imágenes de los negocios (para las páginas públicas)
      allow read: if true;

      // Escritura (crear, actualizar, eliminar): solo el admin o staff del negocio correspondiente
      allow write: if isBusinessAdminOrStaff(businessId);
    }

    // Opcional: Regla general para otros paths si los hubiera en el futuro.
    // Por ahora, se deniega el acceso a cualquier otra ruta.
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
