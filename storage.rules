rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Regla general: por defecto, nadie puede leer o escribir.
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Regla específica para las imágenes de los negocios.
    // Permite la escritura (subida/actualización/eliminación) en la carpeta de un negocio
    // si el usuario está autenticado y su perfil en Firestore está vinculado a ese businessId
    // con un rol de 'business_admin' o 'staff'.
    match /businesses/{businessId}/{allPaths=**} {
      allow read; // Permitir lectura pública de las imágenes de los negocios.
      allow write: if request.auth != null &&
                      exists(/databases/(default)/documents/platformUsers/$(request.auth.uid)) &&
                      (
                        // El usuario es un business_admin o staff de ESE negocio.
                        (get(/databases/(default)/documents/platformUsers/$(request.auth.uid)).data.businessId == businessId &&
                         get(/databases/(default)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['business_admin', 'staff']))
                        ||
                        // El usuario es un superadmin.
                        get(/databases/(default)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin'])
                      );
    }
  }
}
