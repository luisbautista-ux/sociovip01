rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- REGLAS GLOBALES ---
    // Función para verificar si un usuario es Super Administrador
    function isSuperAdmin(userId) {
      return exists(/databases/$(database)/documents/platformUsers/$(userId)) &&
             get(/databases/$(database)/documents/platformUsers/$(userId)).data.roles[0] == 'superadmin';
    }

    // Función para verificar si un usuario es un Administrador de Negocio o Staff de un negocio específico
    function isBusinessAdminOrStaff(userId, businessId) {
      let userRoles = get(/databases/$(database)/documents/platformUsers/$(userId)).data.roles;
      let userBusinessId = get(/databases/$(database)/documents/platformUsers/$(userId)).data.businessId;
      return exists(/databases/$(database)/documents/platformUsers/$(userId)) &&
             (userRoles[0] == 'business_admin' || userRoles[0] == 'staff') &&
             userBusinessId == businessId;
    }

    // --- COLECCIÓN DE NEGOCIOS (businesses) ---
    match /businesses/{businessId} {
      // Lectura pública para que las páginas de negocio se muestren a todos.
      allow read: if true;

      // Creación, actualización y eliminación solo para Super Administradores.
      allow create, update, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }
    
    // --- COLECCIÓN DE USUARIOS DE PLATAFORMA (platformUsers) ---
    match /platformUsers/{userId} {
        // Lectura: Un usuario puede leer su propio perfil. Un Super Admin puede leer todos.
        // Un Admin/Staff de negocio puede leer los perfiles de su mismo negocio.
        allow read: if request.auth != null && 
                       (request.auth.uid == userId || isSuperAdmin(request.auth.uid) ||
                        isBusinessAdminOrStaff(request.auth.uid, resource.data.businessId));
                        
        // Escritura (Crear/Actualizar): Un usuario puede actualizar su propio perfil. Un Super Admin puede escribir en todos.
        allow write: if request.auth != null && (request.auth.uid == userId || isSuperAdmin(request.auth.uid));
        
        // Eliminación: Solo un Super Admin puede eliminar perfiles de usuario.
        allow delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }

    // --- COLECCIÓN DE ENTIDADES DE NEGOCIO (businessEntities: promociones, eventos) ---
    match /businessEntities/{entityId} {
      // Lectura pública para que las promociones y eventos se muestren a todos.
      allow read: if true;

      // Creación y actualización: Permitido para Super Admins y para Admins/Staff del negocio correspondiente.
      allow create, update: if request.auth != null && 
                               (isSuperAdmin(request.auth.uid) || 
                                isBusinessAdminOrStaff(request.auth.uid, request.resource.data.businessId));
                               
      // Eliminación: Permitido para Super Admins y para Admins del negocio correspondiente.
      allow delete: if request.auth != null &&
                        (isSuperAdmin(request.auth.uid) || 
                         isBusinessAdminOrStaff(request.auth.uid, resource.data.businessId));
    }
    
     // --- COLECCIÓN DE CLIENTES QR (qrClients) ---
    match /qrClients/{clientId} {
      // Lectura: Super Admin puede leer todos, Admin/Staff puede leer los de su negocio.
      allow read: if request.auth != null &&
                      (isSuperAdmin(request.auth.uid) || 
                       isBusinessAdminOrStaff(request.auth.uid, resource.data.generatedForBusinessId));

      // Creación: Cualquiera puede crear un nuevo cliente QR (flujo público).
      allow create: if true;
    }

    // --- COLECCIÓN DE SOCIOS VIP (socioVipMembers) ---
    match /socioVipMembers/{socioId} {
        // Solo los Super Administradores pueden gestionar los Socios VIP.
        allow read, write, delete: if request.auth != null && isSuperAdmin(request.auth.uid);
    }
    
    // --- COLECCIÓN DE VÍNCULOS PROMOTOR-NEGOCIO (businessPromoterLinks) ---
    match /businessPromoterLinks/{linkId} {
        // Lectura: Super Admin y el Admin/Staff del negocio correspondiente.
        allow read: if request.auth != null &&
                      (isSuperAdmin(request.auth.uid) ||
                       isBusinessAdminOrStaff(request.auth.uid, resource.data.businessId));
                       
        // Escritura: Super Admin y el Admin/Staff del negocio correspondiente.
        allow write: if request.auth != null &&
                       (isSuperAdmin(request.auth.uid) ||
                        isBusinessAdminOrStaff(request.auth.uid, request.resource.data.businessId));
                        
        // Eliminación: Super Admin y el Admin/Staff del negocio correspondiente.
        allow delete: if request.auth != null &&
                        (isSuperAdmin(request.auth.uid) ||
                         isBusinessAdminOrStaff(request.auth.uid, resource.data.businessId));
    }

  }
}
