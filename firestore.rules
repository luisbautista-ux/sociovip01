rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data;
    }

    function isSuperAdmin() {
      return isSignedIn() && getUserData().roles[0] == 'superadmin';
    }

    // CORRECCIÓN: Esta función ahora verifica correctamente si 'business_admin' o 'staff'
    // están presentes en el array de roles del usuario.
    function isBusinessMember() {
      let userRoles = getUserData().roles;
      return isSignedIn() && (userRoles.hasAny(['business_admin', 'staff']));
    }

    // --- Reglas por Colección ---

    // Perfiles de Usuario: Solo SuperAdmin puede gestionar. El propio usuario puede leer su perfil.
    match /platformUsers/{userId} {
      allow read, write: if isSuperAdmin();
      allow get: if isSignedIn() && request.auth.uid == userId;
    }

    // Negocios: Lectura pública, escritura solo para SuperAdmin.
    match /businesses/{businessId} {
      allow read: if true;
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Entidades del Negocio (Promociones/Eventos): Lectura pública, escritura para miembros del negocio.
    match /businessEntities/{entityId} {
      allow read: if true;
      allow write: if isBusinessMember() && getUserData().businessId == resource.data.businessId;
    }
    
    // Clientes QR: Creación pública, lectura restringida a miembros del negocio.
    match /qrClients/{clientId} {
      allow create: if true;
      allow read: if isBusinessMember() && getUserData().businessId == resource.data.generatedForBusinessId;
      allow update, delete: if false;
    }

    // Socios VIP: SuperAdmin puede gestionar todo. Miembros del negocio solo pueden leer.
    match /socioVipMembers/{memberId} {
       allow read: if isSuperAdmin() || isBusinessMember();
       allow write: if isSuperAdmin();
    }
    
    // Vínculos de Promotores: Gestión por miembros del negocio.
    match /businessPromoterLinks/{linkId} {
      // CORRECCIÓN: Permite leer/escribir si el usuario es SuperAdmin o un miembro del negocio al que pertenece el vínculo.
      allow read, write: if isSuperAdmin() || (isBusinessMember() && getUserData().businessId == resource.data.businessId);
    }
  }
}
