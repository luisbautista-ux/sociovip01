rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===============================
    //          Helpers
    // ===============================
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData(userId) {
      // Nota: get() en reglas puede leer sin depender de permisos de cliente
      return get(/databases/$(database)/documents/platformUsers/$(userId)).data;
    }

    function isSuperAdmin() {
      if (!isSignedIn()) { return false; }
      let userRoles = getUserData(request.auth.uid).roles;
      return 'superadmin' in userRoles;
    }

    function isBusinessAdmin() {
      if (!isSignedIn()) { return false; }
      let userRoles = getUserData(request.auth.uid).roles;
      return 'business_admin' in userRoles;
    }

    // ===============================
    //        Collections Rules
    // ===============================

    match /businesses/{businessId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /businessEntities/{entityId} {
      allow read: if true;
      allow create: if isSuperAdmin() || (isBusinessAdmin() && request.resource.data.businessId == getUserData(request.auth.uid).businessId);
      allow update: if isSuperAdmin() || (isBusinessAdmin() && resource.data.businessId == getUserData(request.auth.uid).businessId);
      allow delete: if isSuperAdmin() || (isBusinessAdmin() && resource.data.businessId == getUserData(request.auth.uid).businessId);
    }

    match /qrClients/{clientId} {
      allow get, list: if true;
      allow create: if true;
      allow update, delete: if false;
    }

    match /platformUsers/{userId} {
      allow get, list: if isSignedIn();
      
      allow create: if isSuperAdmin() || (
        isBusinessAdmin() &&
        request.resource.data.businessId == getUserData(request.auth.uid).businessId &&
        !request.resource.data.roles.hasAny(['superadmin', 'business_admin'])
      );
      
      allow update: if isSuperAdmin() || (
        isBusinessAdmin() &&
        resource.data.businessId == getUserData(request.auth.uid).businessId &&
        !request.resource.data.roles.hasAny(['superadmin', 'business_admin'])
      );

      allow delete: if isSuperAdmin() || (
        isBusinessAdmin() &&
        resource.data.businessId == getUserData(request.auth.uid).businessId &&
        !resource.data.roles.hasAny(['superadmin'])
      );
    }

    match /businessPromoterLinks/{linkId} {
      allow read: if isSignedIn();
      allow create, update: if isSuperAdmin() || (isBusinessAdmin() && request.resource.data.businessId == getUserData(request.auth.uid).businessId);
      allow delete: if isSuperAdmin() || (isBusinessAdmin() && resource.data.businessId == getUserData(request.auth.uid).businessId);
    }

    // Socios VIP: Superadmin tiene control total, Business Admin puede leer.
    match /socioVipMembers/{memberId} {
      allow read: if isSuperAdmin() || isBusinessAdmin();
      allow write: if isSuperAdmin();
    }
  }
}
