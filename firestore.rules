rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones Helper ---
    function isSuperAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']);
    }

    function isBusinessOwnerOrStaff(businessId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.businessId == businessId &&
             get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['business_admin', 'staff']);
    }

    function isHostForBusiness(businessId) {
       return isSignedIn() && 
             get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.businessId == businessId &&
             get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['host']);
    }

    function isAnyBusinessRole(businessId) {
       return isSignedIn() && 
             get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.businessId == businessId &&
             get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['business_admin', 'staff', 'host']);
    }
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isPromoter() {
        return isSignedIn() && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['promoter']);
    }
    
    // --- Colecciones ---

    // BUSINESSES: Solo SuperAdmin puede gestionar negocios.
    match /businesses/{businessId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    
    // BUSINESS_ENTITIES (Promociones, Eventos, etc.):
    // Cualquiera puede leer. Solo el personal del negocio asociado puede escribir.
    match /businessEntities/{entityId} {
      allow read: if true;
      
      // Permitir creación/eliminación solo a staff/admin del negocio.
      allow create, delete: if isBusinessOwnerOrStaff(request.resource.data.businessId);

      // Permitir actualización bajo condiciones específicas
      allow update: if 
          // 1. El staff del negocio puede actualizar cualquier cosa.
          isBusinessOwnerOrStaff(resource.data.businessId) ||
          // 2. Un promotor puede actualizar el array de códigos si añade códigos generados por él.
          (isPromoter() && request.resource.data.generatedCodes.size() > resource.data.generatedCodes.size()) ||
          // 3. Un usuario público puede actualizar el array de códigos SI Y SÓLO SI el único cambio es marcar un código como 'redeemed'.
          (request.auth == null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['generatedCodes']) &&
          request.resource.data.generatedCodes.size() == resource.data.generatedCodes.size());
    }

    // PLATFORM_USERS: Solo SuperAdmin puede gestionar usuarios de la plataforma.
    match /platformUsers/{userId} {
      allow read: if isSuperAdmin() || request.auth.uid == userId;
      allow write: if isSuperAdmin();
    }

    // QR_CLIENTS:
    // Permitir lectura pública (get, list) para verificar DNI.
    // Solo SuperAdmin o personal del negocio puede crear/modificar.
    match /qrClients/{clientId} {
      allow get, list: if true;
      allow create: if true; // Cualquiera puede crear un perfil de cliente QR al registrarse
      allow update, delete: if isSuperAdmin() || isAnyBusinessRole(resource.data.businessId);
    }
    
    // SOCIO_VIP_MEMBERS:
    // Solo SuperAdmin puede gestionar socios VIP, pero se permite la consulta por DNI.
    match /socioVipMembers/{memberId} {
      allow get, list: if true; // Permite la consulta para verificar DNI
      allow write: if isSuperAdmin();
    }
    
    // BUSINESS_PROMOTER_LINKS:
    // El personal del negocio puede gestionar los vínculos de su negocio.
    match /businessPromoterLinks/{linkId} {
      allow read: if isAnyBusinessRole(resource.data.businessId) || isPromoter();
      allow write: if isBusinessOwnerOrStaff(request.resource.data.businessId);
    }
  }
}
