rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para la colección de Negocios
    match /businesses/{businessId} {
      // Lectura: Cualquiera puede leer la información pública de un negocio.
      allow read: if true;
      
      // Escritura (Crear, Actualizar, Eliminar): Solo los Super Administradores.
      allow write: if request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']);
    }

    // Reglas para la colección de Usuarios de la Plataforma
    match /platformUsers/{userId} {
      // Lectura: Solo un superadmin o el propio usuario pueden leer un perfil.
      allow read: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']));
      
      // Actualización: El propio usuario puede actualizar su perfil. Los superadmins también pueden (cubierto por la regla de escritura general abajo).
      allow update: if request.auth.uid == userId;
      
      // Creación/Eliminación: Solo los Super Administradores pueden crear o eliminar perfiles directamente.
      // (La creación desde la app se gestiona por funciones de backend/API que usan credenciales de admin)
      allow create, delete: if request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']);
    }

    // Reglas para Entidades de Negocio (Promociones, Eventos)
    match /businessEntities/{entityId} {
      // Lectura: Cualquiera puede leer las entidades (para páginas públicas).
      allow read: if true;

      // Creación/Actualización/Eliminación: Solo admins o staff del negocio correspondiente.
      allow write: if request.auth != null && 
                      (get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['business_admin', 'staff'])) &&
                      (get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.businessId == resource.data.businessId);
    }

    // Reglas para Clientes QR (los que se registran para un código)
    match /qrClients/{clientId} {
        // Lectura: Solo personal del negocio o superadmins.
        allow read: if request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin', 'business_admin', 'staff']);
        
        // Creación: Permitida a cualquiera (público) que se registre para un QR.
        allow create: if true;
        
        // Actualización/Eliminación: Solo superadmins.
        allow update, delete: if request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']);
    }
    
    // Reglas para Miembros SocioVIP
    match /socioVipMembers/{memberId} {
        // Lectura: Solo superadmins.
        allow read: if request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']);
        
        // Escritura: Solo superadmins.
        allow write: if request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']);
    }
    
    // Reglas para los Vínculos Promotor-Negocio
    match /businessPromoterLinks/{linkId} {
        // Lectura: Superadmins, o personal del negocio vinculado.
        allow read: if request.auth != null && 
                      (get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']) || 
                       (get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.businessId == resource.data.businessId));
                       
        // Escritura: Superadmins, o personal del negocio vinculado.
        allow write: if request.auth != null && 
                       (get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny(['superadmin']) || 
                       (get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.businessId == resource.data.businessId));
    }
  }
}