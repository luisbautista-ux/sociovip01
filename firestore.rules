
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user has a specific role
    function isRole(role) {
      return request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.roles.hasAny([role]);
    }

    // Helper function to check if a user is linked to a specific business
    function isLinkedToBusiness(businessId) {
        return request.auth != null && get(/databases/$(database)/documents/platformUsers/$(request.auth.uid)).data.businessId == businessId;
    }

    // Businesses collection
    match /businesses/{businessId} {
      // Superadmins can do anything
      allow read, write: if isRole('superadmin');
      // Business admins/staff can read their own business details
      allow get: if isRole('business_admin') || isRole('staff');
      // Business admins can update their own business settings
      allow update: if (isRole('business_admin') || isRole('staff')) && isLinkedToBusiness(businessId);
    }
    
    // Platform Users collection
    match /platformUsers/{userId} {
      // Superadmins can read/write all user profiles
      allow read, write: if isRole('superadmin');
      // Users can read their own profile
      allow get: if request.auth != null && request.auth.uid == userId;
    }

    // Business Entities (Promotions, Events)
    match /businessEntities/{entityId} {
      // Superadmins can manage all entities
      allow read, write: if isRole('superadmin');
      // Logged-in users can read entities for public pages
      allow get: if request.auth != null;
      // Anyone can read entities (for public pages)
      allow list: if true;
      // Business admins/staff can manage entities for their own business
      allow create, update, delete: if (isRole('business_admin') || isRole('staff')) && isLinkedToBusiness(request.resource.data.businessId);
    }
    
    // QR Clients collection
    match /qrClients/{clientId} {
      // Superadmins can read all QR clients
      allow read: if isRole('superadmin');
      // Allow creation by anyone (public forms)
      allow create: if true;
    }

    // Socio VIP Members collection
    match /socioVipMembers/{memberId} {
      // Superadmins can manage all VIP members
      allow read, write: if isRole('superadmin');
    }

    // Business Promoter Links collection
    match /businessPromoterLinks/{linkId} {
        // Superadmins can manage all links
        allow read, write: if isRole('superadmin');
        // Business admins/staff can manage links for their own business
        allow read, write: if (isRole('business_admin') || isRole('staff')) && isLinkedToBusiness(request.resource.data.businessId);
    }
  }
}
